#!/usr/bin/env python3
from concurrent.futures import ThreadPoolExecutor, wait
import os
import subprocess


def list_files():
    for file in os.listdir():
        if file.lower().endswith(".qta"):
            yield file


def convert_file(qta_file):
    m4a_file = qta_file.rsplit(".", 1)[0] + ".m4a"
    print(f"{qta_file}: converting to {m4a_file}...")
    code = subprocess.run(
        ["ffmpeg", "-i", qta_file, "-acodec", "copy", "-loglevel", "error", m4a_file],
        check=False,
    ).returncode
    if code == 0:
        print(f"{qta_file}: converted to {m4a_file}.")
    else:
        print(f"{qta_file}: failed to convert, error code {code}!")


def main():
    with ThreadPoolExecutor() as executor:
        futures = []
        futures = [executor.submit(convert_file, f) for f in list_files()]
        wait(futures)


if __name__ == "__main__":
    main()
